trigger:
  - master

pool:
  name: Azure Pipelines
#  vmImage: 'ubuntu-latest'

stages:
  - stage: Build_Image
    displayName: 'Build Image'
    jobs:
      - job: Build_And_Publish
        steps:
          - task: DownloadSecureFile@1
            name: NuGetConfig
            inputs:
              secureFile: 'NuGet.Config'
          - task: CmdLine@2
            inputs:
              script: |
                sudo apt-get update
                sudo apt-get -y install podman
            displayName: Install Podman
          - task: CmdLine@2
            inputs:
              script: |
                echo "Installing S2I CLI (s2i)..."
                curl -LO "https://github.com/openshift/source-to-image/releases/download/v1.5.1/source-to-image-v1.5.1-c301811d-linux-amd64.tar.gz"
                tar -xzf source-to-image-v1.5.1-c301811d-linux-amd64.tar.gz
                sudo mv s2i /usr/local/bin/
                s2i version
            displayName: Install S2I CLI
          - task: PowerShell@2
            displayName: Get Project Version
            name: SetVersion
            inputs:
              targetType: inline
              script: |
                $version = dotnet msbuild src/WebApi.App/WebApi.App.csproj -getproperty:Version
                Write-Host "##vso[task.setvariable variable=appVersion]$version"
                Write-Host "App version: $version"
          - task: CmdLine@2
            inputs:
              script: |
                echo "Version:${appVersion}"
                docker login registry.redhat.io -u $(RedHatUsername) -p $(RedHatPassword) 
                s2i build . registry.redhat.io/rhel8/dotnet-90:latest quay.io/pminkows/webapi-app:$(appVersion) --volume $(NuGetConfig.secureFilePath):/opt/app-root/src/nuget.config:Z --context-dir src/WebApi.App --dockercfg-path /home/vsts/work/.config/containers/auth.json
                docker images
            displayName: Build App
          - task: CmdLine@2
            inputs:
              script: |
                docker login quay.io -u pminkows -p $(RedHatPassword)
                docker push quay.io/pminkows/webapi-app:$(appVersion)
            displayName: Push Image